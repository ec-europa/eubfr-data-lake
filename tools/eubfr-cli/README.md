<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

- [Resources][1]
  - [Usage][2]
  - [Deploy][3]
  - [Delete][4]
- [Introduction][5]
  - [Usage][6]
- [Demo][7]
  - [Usage][8]
  - [Deploy][9]
- [Environment][10]
  - [Usage][11]
  - [GenerateVariables][12]
- [Services][13]
  - [Usage][14]
  - [Deploy][15]
  - [Delete][16]
  - [Delete][17]
- [Content][18]
  - [Usage][19]
  - [Notes][20]
  - [Upload][21]
  - [Show][22]
  - [Delete][23]
- [Elasticsearch][24]
  - [Usage][25]
  - [snapshotExec][26]
  - [showDomains][27]
  - [showCluster][28]
  - [showIndices][29]
  - [createIndex][30]
  - [deleteIndices][31]

## Resources

Manage resources

### Usage

```sh
$ eubfr-cli resources -h
```

### Deploy

Create all necessary AWS resources, such as S3 buckets for raw and harmonized storages.

Usage:

```sh
$ eubfr-cli resources deploy
```

### Delete

Delete resource services.

List: resources-raw-storage, resources-harmonized-storage.

Especially useful when usually resources-harmonized-storage will fail on deployment.

Usage:

```sh
$ eubfr-cli resources delete
```

## Introduction

EUBFR CLI

Low-level utilities for managing assets of EUBFR data lake.

Please refer to [Getting Started guide][32] before jumping into using the utility.

Each command and sub-command has a help menu, which you can open by passing `-h` or `--help` flags without any arguments.

### Usage

```sh
$ eubfr-cli -h
```

## Demo

Manage demo applications

### Usage

```sh
$ eubfr-cli demo -h
```

### Deploy

Usage:

```sh
$ eubfr-cli demo deploy -h
```

Examples:

Deploy all demo applications for all producers.

```sh
$ eubfr-cli demo deploy
```

Deploy all services, only for working with the AGRI producer.

```sh
$ eubfr-cli demo deploy -p agri
```

## Environment

Manage environment

### Usage

```sh
$ eubfr-cli env -h
```

### GenerateVariables

The EUBFR CLI depends on a few environment variables which point to service API endpoints which are necessary for some commands to work.
For example, when you want to use commands related to content upload, the CLI will go to `@eubfr/storage-signed-uploads` service and seek for `SIGNED_UPLOADS_API` stored in `.env` file local to the service.
This endpoint is necessary for the CLI and other clients (client-side apps) to upload files to the data lake by signed uploads approach in AWS.
For this `.env` file to exist in the service, the serverless service itself has to be deployed on AWS in order for the cloud to generate information about the endpoint resulted out of the resource creation.
The `generate-variables` command helps you generate such `.env` files by re-uploading the serverless service (which you normally do by `npx sls deploy` from the folder of the service) and then running an export function. (which you usually do by `npx sls export-env`)

There are several services which require information from `.env` files, i.e. environment variables in overall.
These `.env` files are normally generated automatically for you when you deploy all services setting up your development environment.
However, if you receive an error for a missing environment variable, you can use this command to regenerate information about the necessary variables.

For instance, you may try to get information about available Elasticsearch domains which are manageable by the CLI running `eubfr-cli es`.
If you haven't deployed `@eubfr/demo-dashboard-client` or you have switched between staging environments working on different branches at the same code base, then you'll get an error like this:

    ENOENT: no such file or directory, open '.../eubfr-data-lake/demo/dashboard/client/.env'

Or it could be also any other message that hints for a requirement of a given named environment variable, such as `SIGNED_UPLOADS_API`.

These are signs that you need to re-generate all necessary `.env` files which contain information about the API endpoints.

Usage:

```sh
$ eubfr-cli env generate-variables
```

## Services

Manage services

### Usage

```sh
$ eubfr-cli services -h
```

### Deploy

Usage:

```sh
$ eubfr-cli services deploy -h
```

Examples:

Deploy all services for all producers.

```sh
$ eubfr-cli services deploy
```

Deploy all services, only for working with the AGRI producer.

```sh
$ eubfr-cli services deploy -p agri
```

(Re-)Deploy only a set of services for working a given producer.

```sh
$ eubfr-cli services deploy foo bar -p agri
```

### Delete

Remove a demo application.

Usage:

```sh
$ eubfr-cli demo delete -h
```

Examples:

Delete all demo applications.

```sh
$ eubfr-cli demo delete
```

Delete only demo application of AGRI producer.

```sh
$ eubfr-cli demo delete -p agri
```

### Delete

Remove a serverless service from AWS cloud.

Usage:

```sh
$ eubfr-cli services delete -h
```

Examples:

Delete all services.

```sh
$ eubfr-cli services delete
```

Delete only a given set of services.

```sh
$ eubfr-cli services delete storage-signed-uploads storage-deleter
```

## Content

Manage content

### Usage

```sh
$ eubfr-cli content -h
```

### Notes

If you want to make use of the CLI to automatically upload or delete all content of a given stage, you can optionally create a `.content` folder in the root of your project, with the following example structure:

    .
    ├── agri
    │   └── agri_history.csv
    ├── eac
    │   └── CreativeEurope_Projects_Overview_2017-08-21.xls
    ├── iati
    │   └── activity.csv
    ├── inforegio
    │   ├── EUBFR_VIEW_16052018.xml
    │   └── regio_projects.json
    ├── valor
    │   └── valor_sample.xls
    └── wifi4eu
        └── wifi4euRegistrations.xlsx

This content can be found at [eubfr-content][33] S3 bucket. If you have `aws` CLI installed, create the folder and get the content by:

```sh
$ mkdir .content && aws s3 sync s3://eubfr-content ./.content
```

There are 2 abstracted operations on a project level:

- `yarn content:upload` uploads files from `.content` producers' folders to their respective S3 buckets in the cloud. This triggers the ingestion process.
- `yarn content:delete` deletes all the currently uploaded content of all producers, for a given stage.

You will need to have the `config.json` file correctly setup in the root folder of the project, as producers' credentials are currently stored only there in the existing workflows.

### Upload

Upload content to the data lake.

Usage:

```sh
$ eubfr-cli content upload -h
```

Examples:

Single file:

```sh
$ eubfr-cli content upload .content/agri/agri_history.csv -p agri
```

Multiple files:

```sh
$ eubfr-cli content upload .content/inforegio/EUBFR_VIEW_16052018.xml .content/inforegio/regio_projects.json -p inforegio
```

All files:

```sh
$ eubfr-cli content upload
```

### Show

Display files of a given producer.

Usage:

```sh
$ eubfr-cli content show -h
```

Examples:

Specific file by `computed_key`:

```sh
$ eubfr-cli content show agri/16598a36-db86-42a0-8041-c0d85021ad97.csv
```

All files of a given producer:

```sh
$ eubfr-cli content show -p agri
```

Please note that if you are sure there's an existing content,
but you can't see it with this command, you'll need to double-check
`eubfr-data-lake/demo/dashboard/client/.env` file to contain
the correct value for `REACT_APP_STAGE`.
If it's not the same as config.json's `stage`, run
`eubfr-cli env generate-variables` to refresh the value of `REACT_APP_STAGE`.

### Delete

Delete files by `computed_key` field.

Usage:

```sh
$ eubfr-cli content delete -h
```

Examples:

Delete one or multiple files:

```sh
$ eubfr-cli content delete agri/foo budg/bar inforegio/baz
```

Delete all files of all producers:

```sh
$ eubfr-cli content delete
```

By default, you will be prompted to confirm your intention.
You can skip the this prompt by adding `--confirm` flag.

## Elasticsearch

Manage Elasticsearch assets

### Usage

```sh
$ eubfr-cli es -h
```

### snapshotExec

- **See: [https://www.elastic.co/guide/en/elasticsearch/reference/6.3/modules-snapshots.html][34]**
- **See: [https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/api-reference-6-2.html#api-snapshot-create-6-2][35]**

Abstracted utility for making use of `snapshot` methods of ES JS SDK

Useful for making backups of indices, such as `.kibana`.

There are a few good reasons why you would want to use EUBFR CLI:

- it knows how to find and use your AWS credentials automatically.
- it provides useful defaults where necessary: such as working with S3 for storage.
- it knows about specific AWS resources which you shouldn't bother to know: S3 backup bucket name, assumed service role arn, etc.
- it also makes a setup of connecting Amazon ES with AWS JS SDK with `http-aws-es`, so all authentication is handled for you.

You could, of course, setup clients and authentication yourself, this command is meant to help you be more productive.

Usage:

```sh
$ eubfr-cli es snapshot-exec -h
```

Examples:

Create a repository:

Note that the integration with S3 has been setup, `body` of request is prepared for you.

```sh
$ eubfr-cli es snapshot-exec createRepository --host https://es.domain/ --params '{ "repository": "repo_name", "verify": true }'
```

Get information about specific repositories:

```sh
$ eubfr-cli es snapshot-exec getRepository --host https://es.domain/ --params '{ "repository": "repo_name" }'
```

Delete a given repository:

```sh
$ eubfr-cli es snapshot-exec deleteRepository --host https://es.domain/ --params '{ "repository": "repo_name" }'
```

Verify a given repository:

```sh
$ eubfr-cli es snapshot-exec verifyRepository --host https://es.domain/ --params '{ "repository": "repo_name" }'
```

Create a snapshot:

```sh
$ eubfr-cli es snapshot-exec create --host https://es.domain/ --params '{ "repository": "repo_name", "snapshot": "snap1" }'
```

Get a snapshot:

```sh
$ eubfr-cli es snapshot-exec get --host https://es.domain/ --params '{ "repository": "repo_name", "snapshot": "snap1" }'
```

Get status of a given snapshot:

```sh
$ eubfr-cli es snapshot-exec status --host https://es.domain/ --params '{ "repository": "repo_name", "snapshot": "snap1" }'
```

### showDomains

Display a list of manageable domains.

Usage:

```sh
$ eubfr-cli es show-domains
```

Useful when you want to see the names of the Elasticsearch domains available for management throught the EUBFR CLI.
This will give you information about the named environment variables holding information about their corresponding hosts. (API endpoints)

### showCluster

Display cluster information about a given domain.

Usage:

```sh
$ eubfr-cli es show-cluster
```

Once you have the basic information about the domains you can manage through the CLI.

Examples:

```sh
$ eubfr-cli es show-cluster -d REACT_APP_ES_PUBLIC_ENDPOINT
```

### showIndices

Display index information.

Usage:

```sh
$ eubfr-cli es show-indices -h
```

This could be useful when you want to query for existing indices so that you either re-use or re-create.

Examples:

```sh
$ eubfr-cli es show-indices -d REACT_APP_ES_PUBLIC_ENDPOINT
```

Since output might be too long to read (and most probably it will be in `dev` stage which is shared between developers), it could help to pipe a `grep` in order to focus on more narrow list.

```sh
 $ eubfr-cli es show-indices -d REACT_APP_ES_PUBLIC_ENDPOINT | grep chernka
```

This will give you a list of existing indices created by the given user. Then, you can make a more narrow query by specifying an index as following:

```sh
$ eubfr-cli es show-indices user-index-1 user-index-2 etc -d REACT_APP_ES_PUBLIC_ENDPOINT
```

### createIndex

Create an index in a given domain with an optional mapping.

Usage:

```sh
$ eubfr-cli es create-index -h
```

Used either when creating a new index with a free structure (no mapping rules) or when creating a new index with specific rules about the document structure.

Simply create a new index:

```sh
$ eubfr-cli es create-index user-index-1 -d REACT_APP_ES_PUBLIC_ENDPOINT
```

Create a new index with mapping:

```sh
$ eubfr-cli es create-index user-index-1 -t project -m ./resources/elasticsearch/mappings/project.js -d REACT_APP_ES_PUBLIC_ENDPOINT
```

This is especially useful when you want to update mapping for a given index without re-creating the whole domain.

### deleteIndices

Delete indices from a given Elasticsearch domain.

Usage:

```sh
$ eubfr-cli es delete-indices -h
```

This could be useful when you want to change mapping of an index without re-creating the whole domain.

```sh
$ eubfr-cli es delete-indices user-index-1 -d REACT_APP_ES_PUBLIC_ENDPOINT
```

If you would like to skip the confirmation, you can use the `--confirm` flag:

```sh
$ eubfr-cli es delete-indices user-index-1 --confirm -d REACT_APP_ES_PUBLIC_ENDPOINT
```

Skipping the `user-index-1` will delete all indices in the given domain, so be extra careful with this command.

[1]: #resources
[2]: #usage
[3]: #deploy
[4]: #delete
[5]: #introduction
[6]: #usage-1
[7]: #demo
[8]: #usage-2
[9]: #deploy-1
[10]: #environment
[11]: #usage-3
[12]: #generatevariables
[13]: #services
[14]: #usage-4
[15]: #deploy-2
[16]: #delete-1
[17]: #delete-2
[18]: #content
[19]: #usage-5
[20]: #notes
[21]: #upload
[22]: #show
[23]: #delete-3
[24]: #elasticsearch
[25]: #usage-6
[26]: #snapshotexec
[27]: #showdomains
[28]: #showcluster
[29]: #showindices
[30]: #createindex
[31]: #deleteindices
[32]: ./docs/GETTING_STARTED.md
[33]: https://s3.console.aws.amazon.com/s3/buckets/eubfr-content/?region=eu-central-1&tab=overview
[34]: https://www.elastic.co/guide/en/elasticsearch/reference/6.3/modules-snapshots.html
[35]: https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/api-reference-6-2.html#api-snapshot-create-6-2

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

- [Introduction][1]
  - [Usage][2]
- [Resources][3]
  - [Usage][4]
  - [Deploy][5]
  - [Delete][6]
- [Services][7]
  - [Usage][8]
  - [Deploy][9]
  - [Delete][10]
- [Environment][11]
  - [Usage][12]
  - [GenerateVariables][13]
- [Elasticsearch][14]
  - [Usage][15]
  - [backupKibana][16]
  - [showDomains][17]
  - [showCluster][18]
  - [showIndices][19]
  - [createIndex][20]
  - [deleteIndices][21]
- [Content][22]
  - [Usage][23]
  - [Notes][24]
  - [Upload][25]
  - [Show][26]
  - [Delete][27]

## Introduction

EUBFR CLI

Low-level utilities for managing assets of EUBFR data lake.

### Usage

```sh
$ npx eubfr-cli -h
```

## Resources

Manage resources

### Usage

```sh
$ npx eubfr-cli resources -h
```

### Deploy

Create all necessary AWS resources, such as S3 buckets for raw and harmonized storages.

Usage:

```sh
$ npx eubfr-cli resources deploy
```

### Delete

Delete resource services.

List: resources-raw-storage, resources-harmonized-storage.

Especially useful when usually resources-harmonized-storage will fail on deployment.

Usage:

```sh
$ npx eubfr-cli resources delete
```

## Services

Manage services

### Usage

```sh
$ npx eubfr-cli services -h
```

### Deploy

Usage:

```sh
$ npx eubfr-cli services deploy -h
```

Examples:

Deploy all services for all producers.

```sh
$ npx eubfr-cli services deploy
```

Deploy all services, only for working with the AGRI producer.

```sh
$ npx eubfr-cli services deploy -p agri
```

(Re-)Deploy only a set of services for working a given producer.

```sh
$ npx eubfr-cli services deploy foo bar -p agri
```

### Delete

Remove a serverless service from AWS cloud.

Usage:

```sh
$ npx eubfr-cli services delete -h
```

Examples:

Delete all services.

```sh
$ npx eubfr-cli services delete
```

Delete only a given set of services.

```sh
$ npx eubfr-cli services delete storage-signed-uploads
```

## Environment

Manage environment

### Usage

```sh
$ npx eubfr-cli env -h
```

### GenerateVariables

That's probably the first operation you'd like to execute before using the EUBFR CLI.

The command will generate `.env` files for all services which contain variable exports which are necessary for the proper functioning of the CLI.

For instance, you may try to get information about available Elasticsearch domains which are manageable by the CLI running `npx eubfr-cli es`.

If you haven't deployed `@eubfr/demo-dashboard-client` or you have switched between staging environments working on different branches at the same code base, then you'll get an error like this:

    ENOENT: no such file or directory, open '.../eubfr-data-lake/demo/dashboard/client/.env'

Or it could be also any other message that hints for a requirement of a given named environment variable, such as `SIGNED_UPLOADS_API`.

These are signs that you need to re-generate all necessary `.env` files which contain information about the API endpoints.

Usage:

```sh
$ npx eubfr-cli env generate-variables
```

## Elasticsearch

Manage Elasticsearch assets

### Usage

```sh
$ npx eubfr-cli es -h
```

### backupKibana

Backup .kibana index for a given host.

Usage:

```sh
$ npx eubfr-cli es backup-kibana -h
```

Example:

```sh
$ npx eubfr-cli es backup-kibana --host https://search-test-public-ip4o6f4o6ziykrbjm4kdpyosfu.eu-central-1.es.amazonaws.com/
```

### showDomains

Display a list of manageable domains.

Usage:

```sh
$ npx eubfr-cli es show-domains
```

Useful when you want to see the names of the Elasticsearch domains available for management throught the EUBFR CLI.
This will give you information about the named environment variables holding information about their corresponding hosts. (API endpoints)

### showCluster

Display cluster information about a given domain.

Usage:

```sh
$ npx eubfr-cli es show-cluster
```

Once you have the basic information about the domains you can manage through the CLI.

Examples:

```sh
$ npx eubfr-cli es show-cluster -d ES_PUBLIC_ENDPOINT
```

### showIndices

Display index information.

Usage:

```sh
$ npx eubfr-cli es show-indices -h
```

This could be useful when you want to query for existing indices so that you either re-use or re-create.

Examples:

```sh
$ npx eubfr-cli es show-indices -d ES_PUBLIC_ENDPOINT
```

Since output might be too long to read (and most probably it will be in `dev` stage which is shared between developers), it could help to pipe a `grep` in order to focus on more narrow list.

```sh
 $ npx eubfr-cli es show-indices -d ES_PUBLIC_ENDPOINT | grep chernka
```

This will give you a list of existing indices created by the given user. Then, you can make a more narrow query by specifying an index as following:

```sh
$ npx eubfr-cli es show-indices user-index-1 user-index-2 etc -d ES_PUBLIC_ENDPOINT
```

### createIndex

Create an index in a given domain with an optional mapping.

Usage:

```sh
$ npx eubfr-cli es create-index -h
```

Used either when creating a new index with a free structure (no mapping rules) or when creating a new index with specific rules about the document structure.

Simply create a new index:

```sh
$ npx eubfr-cli es create-index user-index-1 -d ES_PUBLIC_ENDPOINT
```

Create a new index with mapping:

```sh
$ npx eubfr-cli es create-index user-index-1 -t project -m ./resources/elasticsearch/mappings/project.js -d ES_PUBLIC_ENDPOINT
```

This is especially useful when you want to update mapping for a given index without re-creating the whole domain.

### deleteIndices

Delete indices from a given Elasticsearch domain.

Usage:

```sh
$ npx eubfr-cli es delete-indices -h
```

This could be useful when you want to change mapping of an index without re-creating the whole domain.

```sh
$ npx eubfr-cli es delete-indices user-index-1 -d ES_PUBLIC_ENDPOINT
```

If you would like to skip the confirmation, you can use the `--confirm` flag:

```sh
$ npx eubfr-cli es delete-indices user-index-1 --confirm -d ES_PUBLIC_ENDPOINT
```

Skipping the `user-index-1` will delete all indices in the given domain, so be extra careful with this command.

## Content

Manage content

### Usage

```sh
$ npx eubfr-cli content -h
```

### Notes

If you want to make use of the CLI to automatically upload or delete all content of a given stage, you can optionally create a `.content` folder in the root of your project, with the following example structure:

    .
    ├── agri
    │   └── agri_history.csv
    ├── budg
    │   └── CreativeEurope_Projects_Overview_2017-08-21.xls
    ├── iati
    │   └── activity.csv
    ├── inforegio
    │   ├── EUBFR_VIEW_16052018.xml
    │   └── regio_projects.json
    ├── valor
    │   └── valor_sample.xls
    └── wifi4eu
        └── wifi4euRegistrations.xlsx

There are 2 abstracted operations on a project level:

- `yarn content:upload` uploads files from `.content` producers' folders to their respective S3 buckets in the cloud. This triggers the ingestion process.
- `yarn content:delete` deletes all the currently uploaded content of all producers, for a given stage.

You will need to have the `config.json` file correctly setup in the root folder of the project, as producers' credentials are currently stored only there in the existing workflows.

### Upload

Upload content to the data lake.

Usage:

```sh
$ npx eubfr-cli content upload -h
```

Examples:

Single file:

```sh
$ npx eubfr-cli content upload .content/agri/agri_history.csv -p agri
```

Multiple files:

```sh
$ npx eubfr-cli content upload .content/inforegio/EUBFR_VIEW_16052018.xml .content/inforegio/regio_projects.json -p inforegio
```

All files:

```sh
$ npx eubfr-cli content upload
```

### Show

Display files of a given producer.

Usage:

```sh
$ npx eubfr-cli content show -h
```

Examples:

Specific file by `computed_key`:

```sh
$ npx eubfr-cli content show agri/16598a36-db86-42a0-8041-c0d85021ad97.csv
```

All files of a given producer:

```sh
$ npx eubfr-cli content show -p agri
```

Please note that if you are sure there's an existing content,
but you can't see it with this command, you'll need to double-check
`eubfr-data-lake/demo/dashboard/client/.env` file to contain
the correct value for `REACT_APP_STAGE`.
If it's not the same as config.json's `stage`, run
`npx eubfr-cli env generate-variables` to refresh the value of `REACT_APP_STAGE`.

### Delete

Delete files by `computed_key` field.

Usage:

```sh
$ npx eubfr-cli content delete -h
```

Examples:

Delete one or multiple files:

```sh
$ npx eubfr-cli content delete agri/foo budg/bar inforegio/baz
```

Delete all files of all producers:

```sh
$ npx eubfr-cli content delete
```

By default, you will be prompted to confirm your intention.
You can skip the this prompt by adding `--confirm` flag.

[1]: #introduction
[2]: #usage
[3]: #resources
[4]: #usage-1
[5]: #deploy
[6]: #delete
[7]: #services
[8]: #usage-2
[9]: #deploy-1
[10]: #delete-1
[11]: #environment
[12]: #usage-3
[13]: #generatevariables
[14]: #elasticsearch
[15]: #usage-4
[16]: #backupkibana
[17]: #showdomains
[18]: #showcluster
[19]: #showindices
[20]: #createindex
[21]: #deleteindices
[22]: #content
[23]: #usage-5
[24]: #notes
[25]: #upload
[26]: #show
[27]: #delete-2
